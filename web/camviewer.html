<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒãƒ«ãƒã‚«ãƒ¡ãƒ©ç›£è¦–ãƒ‘ãƒãƒ« v6.5</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #27ae60; --error: #ff4757; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; }
        h1 { text-align: center; color: white; margin-bottom: 30px; font-weight: 300; letter-spacing: 2px; }
        
        .camera-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; max-width: 1600px; margin: 0 auto; }
        
        /* ã‚«ãƒ¼ãƒ‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .camera-card { background: var(--card); border-radius: 12px; padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333; transition: 0.3s; }
        .camera-card:hover { border-color: var(--accent); }
        .camera-name { font-size: 1.2rem; font-weight: bold; margin-bottom: 12px; border-left: 5px solid var(--accent); padding-left: 12px; color: #fff; }
        
        /* æ˜ åƒã‚¨ãƒªã‚¢ */
        .video-wrapper { width: 100%; aspect-ratio: 4/3; background: #000; border-radius: 8px; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid #444; }
        .no-signal { color: #444; font-weight: bold; font-family: 'Courier New', Courier, monospace; letter-spacing: 2px; z-index: 1; }
        .img-stream { width: 100%; height: 100%; object-fit: contain; display: none; z-index: 2; position: absolute; top: 0; left: 0; }
        
        /* ãƒã‚¤ã‚¿ãƒ« & ã‚»ãƒ³ã‚µãƒ¼æƒ…å ± */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; font-size: 0.9rem; font-family: 'Consolas', 'Monaco', monospace; }
        .info-item { background: #252525; padding: 10px; border-radius: 4px; color: #00ff00; border: 1px solid #333; text-shadow: 0 0 5px rgba(0,255,0,0.3); }
        .info-full { grid-column: span 2; color: #888; font-size: 0.75rem; text-align: right; padding-top: 5px; }

        /* ãƒœã‚¿ãƒ³ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .btn { width: 100%; background: var(--accent); color: white; border: none; padding: 14px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.3s; box-shadow: 0 4px 0 #1e8449; }
        .btn:hover { background: #2ecc71; transform: translateY(-1px); }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn:disabled { background: #444; cursor: not-allowed; box-shadow: none; transform: none; }
        .status-msg { margin-top: 12px; font-size: 0.8rem; height: 1.2rem; color: #aaa; text-align: center; font-style: italic; }
    </style>
</head>
<body>

<h1>ğŸ“¡ Multi-Node Monitoring Panel</h1>
<div class="camera-grid" id="gridContainer"></div>

<script>
    const gridContainer = document.getElementById('gridContainer');

    // 1. master_config.json ã‚’èª­ã¿è¾¼ã‚“ã§ã‚«ãƒ¼ãƒ‰ã‚’å‹•çš„ç”Ÿæˆ
    fetch('master_config.json')
    .then(res => res.json())
    .then(config => {
        const nodes = config.nodes;
        Object.keys(nodes).forEach(id => {
            createCameraCard(id, nodes[id].name);
        });
    })
    .catch(err => {
        console.error("Config load error:", err);
        gridContainer.innerHTML = `<p style="color:var(--error); text-align:center;">è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
    });

    function createCameraCard(id, name) {
        const card = document.createElement('div');
        card.className = 'camera-card';
        card.innerHTML = `
            <div class="camera-name">${name} <small style="color:#666; font-weight:normal;">[${id}]</small></div>
            <div class="video-wrapper">
                <div id="nosig-${id}" class="no-signal">NO SIGNAL</div>
                <img id="img-${id}" class="img-stream" alt="camera stream">
            </div>
            
            <div class="info-grid">
                <div class="info-item" id="temp-${id}">Temp: --.-Â°C</div>
                <div class="info-item" id="pir-${id}">PIR: WAIT</div>
                <div class="info-item" id="hum-${id}">Hum: --%</div>
                <div class="info-item" id="pres-${id}">Pres: ----hPa</div>
                <div class="info-full" id="time-${id}">Last Update: ----/--/-- --:--:--</div>
            </div>

            <button id="btn-${id}" class="btn" onclick="startLive('${id}')">VIEW LIVE STREAM</button>
            <div id="stat-${id}" class="status-msg"></div>
        `;
        gridContainer.appendChild(card);
        
        // åˆå›å®Ÿè¡Œã¨å®šæœŸæ›´æ–°ï¼ˆ5ç§’ãŠãï¼‰
        updateVitals(id);
        setInterval(() => updateVitals(id), 5000);
    }

    // 2. ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ï¼ˆ0.0 ãªã©ã®æ•°å€¤ã‚’æ­£ã—ãæ‰±ã†ãŸã‚ã®åˆ¤å®šï¼‰
    function updateVitals(id) {
        fetch(`get_vitals.php?cam_id=${id}`)
        .then(r => r.json())
        .then(data => {
            // æ¸©åº¦è¡¨ç¤º
            const tempVal = (data.temp !== undefined && data.temp !== null) ? data.temp : '--.-';
            document.getElementById(`temp-${id}`).innerText = `Temp: ${tempVal}Â°C`;
            
            // æ¹¿åº¦è¡¨ç¤º (0.0% ã®å ´åˆã§ã‚‚è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«åˆ¤å®š)
            const humVal = (data.humidity !== undefined && data.humidity !== null) ? data.humidity : '--';
            document.getElementById(`hum-${id}`).innerText = `Hum: ${humVal}%`;
            
            // äººæ„Ÿã‚»ãƒ³ã‚µãƒ¼çŠ¶æ…‹
            document.getElementById(`pir-${id}`).innerText  = `PIR: ${data.motion_state || 'inactive'}`;
            
            // æ›´æ–°æ™‚åˆ»
            document.getElementById(`time-${id}`).innerText = `Last Update: ${data.updated_at || '----/--/-- --:--:--'}`;
            
            // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã«ã‚ˆã‚‹æ–‡å­—è‰²ã®å¤‰åŒ–
            const nosig = document.getElementById(`nosig-${id}`);
            if (data.is_online) {
                nosig.style.color = "var(--accent)";
                nosig.innerText = "READY";
            } else {
                nosig.style.color = "#444";
                nosig.innerText = "OFFLINE";
            }
        })
        .catch(e => console.warn(`Vital update failed for ${id}:`, e));
    }

    // 3. ãƒ©ã‚¤ãƒ–é…ä¿¡ã®é–‹å§‹ï¼ˆApacheã®ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ï¼‰
    function startLive(id) {
        const btn = document.getElementById(`btn-${id}`);
        const stat = document.getElementById(`stat-${id}`);
        const img = document.getElementById(`img-${id}`);
        const nosig = document.getElementById(`nosig-${id}`);

        btn.disabled = true;
        stat.innerText = "âš¡ å‘½ä»¤é€ä¿¡ä¸­...";

        const fd = new FormData();
        fd.append('cam_id', id);
        fd.append('command', 'start_motion'); 

        fetch('send_cmd.php', { method: 'POST', body: fd })
        .then(r => r.text())
        .then(() => {
            stat.innerText = "â³ ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­ (3ç§’å¾…ã¡)...";
            
            // MJPG-Streamer ãŒç”»åƒã‚’ç”Ÿæˆã™ã‚‹ã¾ã§å°‘ã—å¾…æ©Ÿ
            // camviewer.html ã® startLive å†…ã®ä¿®æ­£ã‚¤ãƒ¡ãƒ¼ã‚¸
            setTimeout(() => {
                // 1æšè¡¨ç¤º
                img.style.display = 'block';
                nosig.style.display = 'none';
                stat.innerText = "ğŸŸ¢ WildLink WMPå—ä¿¡ä¸­...";
            
                // ãƒ‘ãƒ©ãƒ‘ãƒ©æ¼«ç”»é–‹å§‹
                const refreshInterval = setInterval(() => {
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å›é¿ã™ã‚‹ãŸã‚ã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä»˜ä¸
                    img.src = "latest.jpg?t=" + new Date().getTime();
                }, 100); // 0.1ç§’ãŠãã«æœ€æ–°ã® latest.jpg ã‚’å–å¾—

                // 30ç§’å¾Œã«åœæ­¢
                setTimeout(() => {
                    clearInterval(refreshInterval); // ãƒ«ãƒ¼ãƒ—åœæ­¢
                    img.style.display = 'none';
                    nosig.style.display = 'flex';
                    stat.innerText = "â¹ é…ä¿¡ã‚’çµ‚äº†ã—ã¾ã—ãŸ";
                    btn.disabled = false;
        
                    // é€ä¿¡å´ã«ã‚‚åœæ­¢å‘½ä»¤ã‚’é£›ã°ã™
                    sendStopCommand(id); 
                }, 30000);
            }, 1000); // èµ·å‹•å¾…ã¡æ™‚é–“ã¯1ç§’ãã‚‰ã„ã§ååˆ†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“
        })
        .catch(err => {
            stat.innerText = "âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼";
            btn.disabled = false;
            console.error(err);
        });
    }
</script>
</body>
</html>